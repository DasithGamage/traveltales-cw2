<%- include('layout') %>

<h2>Welcome to TravelTales!</h2>

<% if (session && session.user) { %>
  <p>You are logged in as <strong><%= session.user.name %></strong></p>
  <p><a href="/blog/create">Create a new blog post</a></p>

  <% if (typeof followerCount !== 'undefined' && typeof followingCount !== 'undefined') { %>
    <p><strong>Followers:</strong> <%= followerCount %></p>
    <p><strong>Following:</strong> <%= followingCount %></p>
  <% } %>
<% } else { %>
  <p>Please <a href="/login">log in</a> or <a href="/register">register</a> to get started.</p>
<% } %>

<!-- Country Information Dropdown (Requirement 8.1) -->
<div style="background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px;">
  <h3>Explore Countries</h3>
  <select id="countryDropdown" style="padding: 8px; width: 300px;">
    <option value="">Select a country to view information...</option>
  </select>
  <div id="countryInfo" style="margin-top: 15px; display: none;">
    <p><strong>Flag:</strong> <span id="countryFlag"></span></p>
    <p><strong>Capital:</strong> <span id="countryCapital"></span></p>
    <p><strong>Currency:</strong> <span id="countryCurrency"></span></p>
  </div>
</div>

<script>
// Fetch all countries for the dropdown
fetch('https://restcountries.com/v3.1/all')
  .then(response => response.json())
  .then(countries => {
    const dropdown = document.getElementById('countryDropdown');
    countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
    countries.forEach(country => {
      const option = document.createElement('option');
      option.value = country.name.common;
      option.textContent = country.name.common;
      option.dataset.flag = country.flag || '';
      option.dataset.capital = country.capital?.[0] || 'N/A';
      option.dataset.currency = Object.keys(country.currencies || {})[0] || 'N/A';
      dropdown.appendChild(option);
    });
  });

// Display country information when selected
document.getElementById('countryDropdown').addEventListener('change', function(e) {
  const selectedOption = e.target.options[e.target.selectedIndex];
  const infoDiv = document.getElementById('countryInfo');
  
  if (selectedOption.value) {
    document.getElementById('countryFlag').textContent = selectedOption.dataset.flag;
    document.getElementById('countryCapital').textContent = selectedOption.dataset.capital;
    document.getElementById('countryCurrency').textContent = selectedOption.dataset.currency;
    infoDiv.style.display = 'block';
  } else {
    infoDiv.style.display = 'none';
  }
});
</script>

<!-- Only show these sections when NOT searching -->
<% if (!query) { %>
  <!-- üî• Most Liked Posts -->
  <% if (popularPosts && popularPosts.length > 0) { %>
    <h3>üî• Most Liked Posts</h3>
    <% popularPosts.forEach(post => { %>
      <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: #fff5f0;">
        <h4><%= post.title %></h4>
        <p><em>By <%= post.author %> on <%= post.created_at.split('T')[0] %></em></p>
        <% if (post.country) { %>
          <p><strong>Country:</strong> <%= post.country %>
          <% if (post.countryInfo?.flag) { %> | <strong>Flag:</strong> <%= post.countryInfo.flag %><% } %>
          </p>
        <% } %>
        <p><%= post.content.slice(0, 150) %>...</p>
        <a href="/blog/<%= post.id %>">Read more ‚Üí</a>
      </div>
    <% }) %>
  <% } %>

  <!-- üÜï Recent Posts -->
  <% if (recentPosts && recentPosts.length > 0) { %>
    <h3>üÜï Recent Posts</h3>
    <% recentPosts.forEach(post => { %>
      <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: #f0faff;">
        <h4><%= post.title %></h4>
        <p><em>By <%= post.author %> on <%= post.created_at.split('T')[0] %></em></p>
        <% if (post.country) { %>
          <p><strong>Country:</strong> <%= post.country %>
          <% if (post.countryInfo?.flag) { %> | <strong>Flag:</strong> <%= post.countryInfo.flag %><% } %>
          </p>
        <% } %>
        <p><%= post.content.slice(0, 150) %>...</p>
        <a href="/blog/<%= post.id %>">Read more ‚Üí</a>
      </div>
    <% }) %>
  <% } %>
<% } %>

<!-- Search Blog Posts with Type Selection -->
<form action="/search" method="GET" style="margin-top: 30px; background-color: #e9ecef; padding: 15px; border-radius: 5px;">
  <h3>Search Blog Posts</h3>
  <div style="display: flex; gap: 10px; align-items: center;">
    <select name="searchType" style="padding: 8px;">
      <option value="country" <%= searchType === 'country' ? 'selected' : '' %>>Search by Country</option>
      <option value="author" <%= searchType === 'author' ? 'selected' : '' %>>Search by Author</option>
    </select>
    <input type="text" name="query" placeholder="Enter search term" value="<%= query || '' %>" style="padding: 8px; width: 300px;" required>
    <button type="submit" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px;">Search</button>
  </div>
</form>

<hr>

<h3><%= query ? `Search Results for "${query}"` : 'Recent Blog Posts' %></h3>

<% if (!blogs || blogs.length === 0) { %>
  <p><%= query ? `No blog posts found matching "${query}".` : 'No blog posts found.' %></p>
<% } else { %>
  <% if (query) { %>
    <p>Found <%= blogs.length %> blog post<%= blogs.length > 1 ? 's' : '' %> matching "<%= query %>".</p>
  <% } %>
  
  <% blogs.forEach(blog => { %>
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 15px;">
      <h4><%= blog.title %></h4>
      <p><em>By <%= blog.author %> on <%= blog.created_at.split('T')[0] %></em></p>
      <% if (blog.country) { %><p>Country: <%= blog.country %></p><% } %>
      <% if (blog.visit_date) { %><p>Visited on: <%= blog.visit_date %></p><% } %>

      <% if (blog.countryInfo) { %>
        <p>
          üåç <strong>Capital:</strong> <%= blog.countryInfo.capital %> |
          <strong>Currency:</strong> <%= blog.countryInfo.currency %> |
          <strong>Flag:</strong> <%= blog.countryInfo.flag %>
        </p>
      <% } %>

      <p><%= blog.content %></p>

      <% if (session.user && session.user.id === blog.user_id) { %>
        <p>
          <a href="/blog/edit/<%= blog.id %>">Edit</a> |
          <a href="/blog/delete/<%= blog.id %>" onclick="return confirm('Are you sure?')">Delete</a>
        </p>
      <% } %>

      <% if (session.user && session.user.id !== blog.user_id) { %>
        <% if (blog.isFollowing) { %>
          <form action="/unfollow/<%= blog.user_id %>" method="POST" style="display:inline;">
            <button type="submit">Unfollow</button>
          </form>
        <% } else { %>
          <form action="/follow/<%= blog.user_id %>" method="POST" style="display:inline;">
            <button type="submit">Follow</button>
          </form>
        <% } %>
      <% } %>

      <p>üëç Likes: <%= blog.likes %> | üëé Dislikes: <%= blog.dislikes %></p>
      <form action="/like/<%= blog.id %>" method="POST" style="display:inline;">
        <button type="submit">üëç Like</button>
      </form>
      <form action="/dislike/<%= blog.id %>" method="POST" style="display:inline;">
        <button type="submit">üëé Dislike</button>
      </form>
    </div>
  <% }) %>

  <!-- Pagination -->
  <div style="margin-top: 20px;">
    <% if (page && page > 1) { %>
      <a href="?<%= query ? `searchType=${searchType}&query=${query}&` : '' %>page=<%= prevPage %>">‚¨Ö Prev</a>
    <% } %>
    <span style="margin: 0 10px;">Page <%= page || 1 %></span>
    <% if (blogs.length === limit) { %>
      <a href="?<%= query ? `searchType=${searchType}&query=${query}&` : '' %>page=<%= nextPage %>">Next ‚û°</a>
    <% } %>
  </div>
<% } %>